import{a as J,r as b,d as O,u as B,o as K,b as Q,w as q,c as Y,e as f,f as v,g as e,t as _,h as l,i as h,j as y,v as k,k as Z,l as ee,m as te,F as R,n as N,p as D,q as G}from"./main-Cn-tXP68.js";import{M as le,_ as se}from"./DeleteModal.vue_vue_type_script_setup_true_lang-CLOTH3bJ.js";const oe="https://ec-course-api.hexschool.io/",V="satarkuo-ts",w=J.create({baseURL:oe});w.interceptors.request.use(s=>{const a=document.cookie.replace(/(?:(?:^|.*;\s*)hexToken\s*=\s*([^;]*).*$)|^.*$/,"$1");return a&&(s.headers.Authorization=a),s},s=>Promise.reject(s));w.interceptors.response.use(s=>Promise.resolve(s),s=>Promise.reject(s.response.data));const ae=s=>w.get(`/v2/api/${V}/admin/products`,{params:s}),ne=s=>w.post(`/v2/api/${V}/admin/product`,{data:s}),ie=s=>{const{data:a,id:g}=s;return w.put(`/v2/api/${V}/admin/product/${g}`,{data:a})},re=s=>w.delete(`/v2/api/${V}/admin/product/${s}`),de=async s=>w.post(`/v2/api/${V}/admin/upload`,s),F=4;function ue(s){try{const a=new URL(s);return["http:","https:"].includes(a.protocol)}catch{return!1}}async function ce(s){const a=new FormData;a.append("file-to-upload",s);try{return(await de(a)).data.imageUrl}catch(g){throw alert("上傳圖片失敗"),g}}function pe(s=[]){const a=b([...s]),g=b(""),r=b("未選擇檔案。"),m=b(null),p=b(!1);return{uploadedImages:a,imageUrlInput:g,fileNameDisplay:r,fileToUpload:m,isUploading:p,addImageUrl:()=>{const u=g.value.trim();if(u){if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片`);return}if(!ue(u)){alert("請輸入有效的圖片 URL 格式 (需包含 http:// 或 https://)");return}a.value.push(u),g.value=""}},handleFileChange:u=>{const n=u.target,i=n.files?.[0];if(n.value="",!i){r.value="未選擇檔案。",m.value=null;return}if(!i.type.startsWith("image/")){alert("請選擇有效的圖片檔案！"),r.value="未選擇檔案。",m.value=null;return}if(a.value.length>=F){alert(`最多只能上傳 ${F} 張圖片！`),r.value="圖片數量已達上限，請先刪除圖片。",m.value=null;return}m.value=i,r.value=i.name},triggerUpload:async()=>{const u=m.value;if(!u){alert("請先選擇圖片檔案");return}if(!p.value)try{p.value=!0;const n=await ce(u);a.value.push(n),m.value=null,r.value="未選擇檔案。",alert("圖片上傳成功！")}catch(n){console.error("圖片上傳失敗:",n),alert("圖片上傳失敗，請稍後再試。")}finally{p.value=!1}},deleteImage:u=>{a.value.splice(u,1)},resetImages:(u=[])=>{a.value=[...u].filter(Boolean),g.value="",r.value="未選擇檔案。",m.value=null,p.value=!1}}}const z=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]});function me(){const s=b(z()),a=b("新增商品"),g=m=>{m?(s.value={...m},a.value="編輯商品"):r()},r=()=>{s.value=z(),a.value="新增商品"};return{form:s,formTitle:a,loadProduct:g,resetForm:r}}const ge={class:"modal-dialog modal-dialog-centered modal-lg"},be={class:"modal-content rounded-lg"},fe={class:"modal-header"},ve={class:"modal-title",id:"addNewProductModalLabel"},_e={class:"modal-body"},ye={class:"row"},he={class:"col-md-6"},Ue={class:"mb-3"},ke={class:"row"},xe={class:"col-6 mb-3"},$e={class:"col-6 mb-3"},we={class:"row"},Ce={class:"col-6 mb-3"},Pe={class:"col-6 mb-3"},Me={class:"mb-3"},Ie={class:"mb-3"},De={class:"mb-3 d-flex align-items-center"},Re={class:"form-check form-switch"},Ve={class:"col-md-6"},Fe={class:"mb-3"},Ne={class:"input-group mb-2"},Se=["disabled"],Te={class:"input-group mb-2"},je={class:"file-name-display form-control rounded-lg"},Be=["disabled"],Le={key:0,class:"spinner-border spinner-border-sm me-1",role:"status","aria-hidden":"true"},Ae={class:"mb-3"},Ee={id:"imagesContainer",class:"d-flex flex-wrap gap-2"},Ge=["src"],ze=["onClick"],Oe=["src"],qe={class:"modal-footer"},He=["disabled"],We=O({__name:"ProductModal",props:{product:{}},emits:["get-products"],setup(s,{expose:a,emit:g}){const r=g,m=B("modalRef");let p=null;K(()=>{m.value&&(p=new le(m.value))}),Q(()=>{p&&p.dispose()});const C=()=>{p&&p.show()},U=()=>{p&&p.hide()},{form:d,formTitle:M,loadProduct:I}=me(),{uploadedImages:u,imageUrlInput:n,fileToUpload:i,fileNameDisplay:c,isUploading:P,addImageUrl:L,triggerUpload:A,handleFileChange:E,deleteImage:H,resetImages:S}=pe();q(()=>s.product,x=>{x.id?(I(x),S([x.imageUrl,...x.imagesUrl??[]].filter(Boolean))):(I(null),S([]))},{immediate:!0,deep:!0});const W=Y(()=>!!s.product.id),T=b(!1),X=async()=>{const[x,...t]=u.value,{id:o,...$}=d.value;$.imageUrl=x,$.imagesUrl=t;const j={...$,imagesUrl:t.filter(Boolean)};T.value=!0;try{W.value&&o?await ie({data:j,id:o}):await ne(j),S([]),U()}catch{alert("新增/編輯產品失敗")}finally{T.value=!1,r("get-products")}};return a({openModal:C,closeModal:U}),(x,t)=>(v(),f("div",{ref_key:"modalRef",ref:m,class:"modal fade",id:"addNewProductModal",tabindex:"-1","aria-labelledby":"addNewProductModalLabel","aria-hidden":"true"},[e("div",ge,[e("div",be,[e("div",fe,[e("h5",ve,_(l(M)),1),e("button",{onClick:U,type:"button",class:"btn-close","data-bs-dismiss":"modal","aria-label":"Close"})]),e("div",_e,[e("div",ye,[e("div",he,[e("form",null,[e("div",Ue,[t[12]||(t[12]=e("label",{for:"productName",class:"form-label"},[y("商品名稱"),e("span",{class:"text-danger ms-1"},"*")],-1)),h(e("input",{"onUpdate:modelValue":t[0]||(t[0]=o=>l(d).title=o),type:"text",class:"form-control rounded-lg",id:"productName"},null,512),[[k,l(d).title]])]),e("div",ke,[e("div",xe,[t[13]||(t[13]=e("label",{for:"productOriginalPrice",class:"form-label"},[y("原價"),e("span",{class:"text-danger ms-1"},"*")],-1)),h(e("input",{"onUpdate:modelValue":t[1]||(t[1]=o=>l(d).origin_price=o),type:"number",class:"form-control rounded-lg",id:"productOriginalPrice"},null,512),[[k,l(d).origin_price]])]),e("div",$e,[t[14]||(t[14]=e("label",{for:"productPrice",class:"form-label"},[y("售價"),e("span",{class:"text-danger ms-1"},"*")],-1)),h(e("input",{"onUpdate:modelValue":t[2]||(t[2]=o=>l(d).price=o),type:"number",class:"form-control rounded-lg",id:"productPrice"},null,512),[[k,l(d).price]])])]),e("div",we,[e("div",Ce,[t[15]||(t[15]=e("label",{for:"productCategory",class:"form-label"},[y("分類"),e("span",{class:"text-danger ms-1"},"*")],-1)),h(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>l(d).category=o),class:"form-control rounded-lg",id:"productCategory"},null,512),[[k,l(d).category]])]),e("div",Pe,[t[16]||(t[16]=e("label",{for:"productUnit",class:"form-label"},[y("單位"),e("span",{class:"text-danger ms-1"},"*")],-1)),h(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>l(d).unit=o),class:"form-control rounded-lg",id:"productUnit"},null,512),[[k,l(d).unit]])])]),e("div",Me,[t[17]||(t[17]=e("label",{for:"productDescription",class:"form-label"},"商品內容",-1)),h(e("textarea",{"onUpdate:modelValue":t[5]||(t[5]=o=>l(d).content=o),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,l(d).content]])]),e("div",Ie,[t[18]||(t[18]=e("label",{for:"productDescription",class:"form-label"},"商品描述",-1)),h(e("textarea",{"onUpdate:modelValue":t[6]||(t[6]=o=>l(d).description=o),class:"form-control rounded-lg",id:"productDescription",rows:"4"},null,512),[[k,l(d).description]])]),e("div",De,[t[19]||(t[19]=e("label",{class:"form-label me-3 mb-0"},"啟用",-1)),e("div",Re,[h(e("input",{"onUpdate:modelValue":t[7]||(t[7]=o=>l(d).is_enabled=o),class:"form-check-input",type:"checkbox",id:"flexSwitchProductEnable","true-value":1,"false-value":0},null,512),[[Z,l(d).is_enabled]])])])])]),e("div",Ve,[e("div",Fe,[t[21]||(t[21]=e("label",{class:"form-label"},[y("上傳圖片 (最多 4 張)"),e("span",{class:"text-danger ms-1"},"*")],-1)),e("div",Ne,[h(e("input",{type:"url",class:"form-control rounded-lg",placeholder:"輸入圖片連結","onUpdate:modelValue":t[8]||(t[8]=o=>ee(n)?n.value=o:null)},null,512),[[k,l(n)]]),e("button",{class:"btn btn-outline-secondary rounded-lg ms-2",type:"button",onClick:t[9]||(t[9]=(...o)=>l(L)&&l(L)(...o)),disabled:l(u).length>=4}," 新增連結 ",8,Se)]),e("div",Te,[t[20]||(t[20]=e("label",{class:"input-group-text rounded-lg",for:"imageInputFile"},"瀏覽...",-1)),e("input",{onChange:t[10]||(t[10]=(...o)=>l(E)&&l(E)(...o)),type:"file",class:"form-control d-none",id:"imageInputFile",accept:".jpg, .jpeg, .png"},null,32),e("div",je,_(l(c)),1),e("button",{onClick:t[11]||(t[11]=(...o)=>l(A)&&l(A)(...o)),disabled:!l(i)||l(P)||l(u).length>=4,class:"btn btn-outline-secondary rounded-lg ms-2",type:"button"},[l(P)?(v(),f("span",Le)):te("",!0),y(" "+_(l(P)?"上傳中...":"上傳圖片"),1)],8,Be)])]),e("div",Ae,[t[23]||(t[23]=e("div",{class:"d-flex justify-content-between align-items-center mb-2"},[e("label",{class:"form-label mb-0"},"已上傳圖片")],-1)),e("div",Ee,[(v(!0),f(R,null,N(l(u),(o,$)=>(v(),f("div",{key:$,class:D(["image-preview-thumbnail-container",{"main-image":$===0}])},[e("img",{src:o,class:"image-preview-thumbnail",alt:"商品圖片預覽"},null,8,Ge),e("button",{class:"btn btn-danger btn-sm delete-btn",onClick:j=>l(H)($)},[...t[22]||(t[22]=[e("i",{class:"fas fa-times"},null,-1)])],8,ze)],2))),128)),(v(!0),f(R,null,N(4-l(u).length,o=>(v(),f("div",{key:"placeholder-"+o,class:"image-preview-thumbnail-container"},[e("img",{src:`https://placehold.co/100x100/e9ecef/adb5bd?text=Image+${l(u).length+o}`,class:"image-preview-thumbnail"},null,8,Oe)]))),128))])])])])]),e("div",qe,[e("button",{onClick:U,type:"button",class:"btn btn-outline-secondary rounded-lg"},"取消"),e("button",{onClick:X,disabled:T.value,type:"button",class:"btn btn-dark rounded-lg"},"儲存",8,He)])])])],512))}}),Xe={class:"d-flex justify-content-end align-items-center mb-4"},Je={class:"card shadow-sm rounded-lg flex-grow-1"},Ke={class:"card-body p-4"},Qe={class:"table-responsive"},Ye={class:"table table-hover align-middle"},Ze={class:"text-secondary"},et={class:"text-nowrap"},tt=["onClick"],lt=["onClick"],st={class:"d-flex justify-content-center mt-4"},ot={class:"pagination"},at={class:"page-item"},nt=["disabled"],it={class:"page-item"},rt=["onClick","disabled"],dt={class:"page-item"},ut=["disabled"],gt=O({__name:"ProductManagement",setup(s){const a=B("productModalRef"),g=B("deleteModalRef"),r=b("1"),m=b([]),p=b({total_pages:0,current_page:0,has_pre:!1,has_next:!1,category:""}),C=async()=>{try{const n=await ae({page:r.value});m.value=n.data.products,p.value=n.data.pagination}catch{alert("取得產品列表失敗")}};q(r,C,{immediate:!0});const U=()=>({id:"",title:"",origin_price:0,price:0,category:"",unit:"",num:0,content:"",description:"",is_enabled:1,imageUrl:"",imagesUrl:[""]}),d=b(U()),M=(n=null)=>{n?d.value={...n,imagesUrl:n.imagesUrl?[...n.imagesUrl]:[""]}:d.value=U(),a.value?.openModal()},I=n=>{g.value?.openModal(()=>u(n))},u=async n=>{try{await re(n)}catch{alert("刪除商品失敗")}finally{C()}};return(n,i)=>(v(),f(R,null,[e("div",Xe,[e("button",{onClick:i[0]||(i[0]=c=>M(null)),type:"button",class:"btn btn-dark rounded-lg px-4 py-2"},[...i[3]||(i[3]=[e("i",{class:"fas fa-plus me-2"},null,-1),y("新增商品 ",-1)])])]),e("div",Je,[e("div",Ke,[e("div",Qe,[e("table",Ye,[i[5]||(i[5]=e("thead",null,[e("tr",null,[e("th",{scope:"col"},"分類"),e("th",{scope:"col"},[y("商品名稱"),e("small",{class:"text-secondary ms-2"},"| ID 編號")]),e("th",{scope:"col"},"原價"),e("th",{scope:"col"},"售價"),e("th",{scope:"col"},"啟用狀態"),e("th",{scope:"col"})])],-1)),e("tbody",null,[(v(!0),f(R,null,N(m.value,c=>(v(),f("tr",{key:c.id},[e("td",null,_(c.category),1),e("td",null,[y(_(c.title),1),i[4]||(i[4]=e("br",null,null,-1)),e("small",Ze,_(c.id),1)]),e("td",null,_(c.origin_price),1),e("td",null,_(c.price),1),e("td",null,[e("span",{class:D(["badge",{"bg-success":c.is_enabled,"bg-light text-secondary":!c.is_enabled}])},_(c.is_enabled?"啟用":"停用"),3)]),e("td",et,[e("button",{onClick:P=>M(c),type:"button",class:"btn btn-sm btn-outline-dark rounded-lg me-2"},"編輯",8,tt),e("button",{onClick:P=>I(c.id),type:"button",class:"btn btn-sm btn-outline-danger rounded-lg"},"刪除",8,lt)])]))),128))])])]),e("nav",st,[e("ul",ot,[e("li",at,[e("button",{onClick:i[1]||(i[1]=c=>r.value=String(Number(r.value)-1)),disabled:!p.value?.has_pre,type:"button",class:D(["page-link",{disabled:!p.value?.has_pre}]),"aria-label":"Previous"},[...i[6]||(i[6]=[e("span",{"aria-hidden":"true"},"«",-1)])],10,nt)]),(v(!0),f(R,null,N(p.value?.total_pages,c=>(v(),f("li",it,[e("button",{onClick:P=>r.value=c.toString(),disabled:r.value===c.toString(),type:"button",class:D(["page-link",{active:r.value===c.toString()}])},_(c),11,rt)]))),256)),e("li",dt,[e("button",{onClick:i[2]||(i[2]=c=>r.value=String(Number(r.value)+1)),disabled:!p.value?.has_next,class:D(["page-link",{disabled:!p.value?.has_next}]),type:"button","aria-label":"Next"},[...i[7]||(i[7]=[e("span",{"aria-hidden":"true"},"»",-1)])],10,ut)])])])])]),G(We,{ref_key:"productModalRef",ref:a,product:d.value,onGetProducts:C},null,8,["product"]),G(se,{ref_key:"deleteModalRef",ref:g,title:"刪除商品",content:"確定要刪除該商品嗎？"},null,512)],64))}});export{gt as default};
